# test tpd evidence

from AbCD.model import VacuumTPD
from AbCD.io_data import In_data
from AbCD.visual import tpd_profile
sitelist, specieslist, reactionlist = In_data.load_mkm('./TPDdata/')
conditionlist = In_data.load_condition('./TPDdata/')

dEa_index = []
dBE_index = [1]
tpd = VacuumTPD(specieslist=specieslist,
              reactionlist=reactionlist,
              dEa_index=dEa_index,
              dBE_index=dBE_index)
tpd.initialize(pump_level=1)

dP = [-25]
out = tpd.fwd_simulation(dP, conditionlist[0], reltol=1e-12, abstol=1e-12)

_, nd = out.shape
des = [2 * (-out[1, i+1] + out[1, i]) for i in range(nd - 1)]

# tpd_profile(conditionlist[0].TemGrid[:-1], des, r_=[100, 500])

print(conditionlist[0].TemGrid)


prior_info = {}
prior_info['type'] = 'Ridge'
prior_info['L2'] = 1e-5

# construct evidence
likeli, prior = tpd.eval_prob(dP, conditionlist, {}, prior_info)
print(likeli, prior)


import numpy as np
T0, Tf = 50, 800
beta = 3.
Ntime = 2000
time = (Tf - T0) / beta
tgrid = np.linspace(0, time, Ntime)

tem = [210.426, 215.199, 219.437, 223.672, 227.531, 231.486, 235.441, 239.305, 242.788, 245.43, 248.071, 250.524, 253.544, 256.471, 259.408, 262.723, 265.768, 267.867, 269.872, 271.505, 273.046, 274.401, 275.66, 276.536, 277.979, 278.675, 280.03, 280.441, 281.529, 282.512, 283.211, 284.579, 285.373, 285.887, 286.594, 287.677, 288.382, 289.088, 289.696, 290.681, 291.099, 291.806, 292.518, 293.233, 294.408, 294.822, 295.523, 296.325, 296.84, 297.74, 298.82, 299.624, 300.712, 301.791, 302.682, 303.857, 305.131, 306.587, 308.512, 310.983, 313.629, 316.172, 318.231, 319.621, 320.908, 322.667, 324.137, 325.228, 326.327, 327.604, 328.709, 329.528, 330.437, 331.623, 332.626, 333.625, 334.522, 335.432, 335.966, 336.862, 338.048, 339.321, 339.757, 340.664, 341.49, 342.486, 343.584, 344.395, 345.406, 345.841, 346.934, 348.125, 349.125, 349.939, 350.942, 352.126, 353.597, 354.122, 355.972, 356.783, 357.696, 358.61, 359.421, 360.517, 361.802, 362.893, 363.987, 365.837, 367.679, 368.865, 370.708, 373.115, 375.43, 378.041, 381.111, 383.627, 386.139, 389.038, 391.933, 395.496, 399.156, 402.625, 406.38, 410.419, 413.802, 417.56, 421.877, 424.982, 427.903, 430.821, 433.268, 436.843, 439.573, 442.304]
rate = [-1.0084491790697889e-06, 1.1933315285659169e-05, 3.277459831976814e-05, 3.479149667790771e-05, 3.6640320172869e-05, 5.7481603206977966e-05, 7.815481137790864e-05, 0.0001272326714259717, 0.0001289134200577547, 0.00018689924785426752, 0.00024488507565078037, 0.00029329063624613025, 0.00037026892358179084, 0.0004566594032554361, 0.0006280957636973002, 0.0008092804662035056, 0.0011035795516287058, 0.001359725643112432, 0.00161570365973298, 0.0018999182533674824, 0.0022123694240159383, 0.002543813054203543, 0.002865508342326805, 0.0031209821343578187, 0.0033957845356543358, 0.003726723941252405, 0.0040579994965768305, 0.004360534250297767, 0.004833496915281498, 0.005202421239957863, 0.00555235310509508, 0.006006491385402841, 0.006365835442878042, 0.006753416077367198, 0.00717881355607147, 0.0076045471845021, 0.008011120278530404, 0.008427105564896691, 0.008814854274249025, 0.009202602983601359, 0.009571359233414544, 0.009996756712118818, 0.01046955130223937, 0.010961170277035892, 0.011367911445927373, 0.01169885085152544, 0.012077019293676612, 0.01251199703958205, 0.012899577674071204, 0.01337237226419176, 0.013769701240745254, 0.014223671446189837, 0.014687053843972404, 0.015074970628187918, 0.015462719337540252, 0.015869460506431735, 0.016314186594401512, 0.016711683645818185, 0.01709052438742207, 0.017299441442352695, 0.017395244114364324, 0.01741541309794572, 0.01731238320681742, 0.017114727167719744, 0.016850681557666638, 0.016586972097339888, 0.016276033600460038, 0.015936354301976697, 0.015662896499585605, 0.015304560891289471, 0.015087744317789469, 0.014842523092412331, 0.014550072830482094, 0.014219973799199915, 0.013936935729607662, 0.01361624889066347, 0.01321992836328904, 0.012946302486034771, 0.012672676608780504, 0.012276188006542899, 0.011946088975260716, 0.01154993652274947, 0.011238325726416906, 0.010936463272148682, 0.010757295468000617, 0.010408203977179292, 0.010125333982450215, 0.009804479068642845, 0.009597074687480825, 0.009276219773673454, 0.008955364859866081, 0.008672662940000185, 0.008351808026192814, 0.008059357764262575, 0.00777631969467032, 0.007427396278712173, 0.007116289706969143, 0.0067670301412846405, 0.006484496296281921, 0.00616364138247455, 0.005909007964759428, 0.005673198931720276, 0.005352344017912905, 0.005060061830845845, 0.0047677796437787835, 0.004428100345295444, 0.004116825698689235, 0.003824879661348531, 0.003476292395116741, 0.0031366130966334, 0.00278802583040161, 0.0024396066390329975, 0.0021005996400023704, 0.001884455365955079, 0.0015741891685279404, 0.0013486327021426643, 0.0010946715838802555, 0.0009260924961124228, 0.0007291087564674574, 0.0006079267801159044, 0.0005151494556414839, 0.00039396747928993083, 0.00031077042201667327, 0.00024656582428256334, 0.0002010175363612446, 0.00013664486376395639, 3.479149667790771e-05, 2.6723903245349407e-05, 5.6473154027908185e-05, 5.781775293333456e-05, 5.899427697558265e-05, 4.185064093139624e-05, 5.260743217480732e-05, 6.336422341821841e-05]

print(np.argmax(rate))
print(tem[np.argmax(rate)])

tem =  [209.087, 212.374, 215.192, 218.292, 221.11, 224.021, 226.839, 230.315, 233.322, 236.984, 240.273, 244.315, 248.265, 252.025, 255.885, 258.991, 262.569, 265.492, 268.99, 271.546, 273.641, 275.832, 277.928, 279.553, 281.182, 282.245, 283.309, 284.756, 285.823, 286.804, 288.063, 288.564, 289.733, 290.616, 291.404, 292.286, 293.266, 293.498, 294.48, 295.461, 295.967, 297.04, 297.931, 298.724, 299.426, 300.407, 301.579, 302.649, 303.445, 304.244, 305.416, 306.016, 307.56, 308.818, 310.271, 312.176, 314.176, 316.723, 319.357, 321.224, 323.085, 324.278, 325.192, 327.044, 327.952, 329.147, 330.15, 331.431, 332.342, 332.971, 334.161, 334.977, 336.072, 337.072, 338.169, 339.17, 340.174, 341.176, 342.083, 343.089, 344.189, 345.381, 346.476, 347.474, 348.573, 349.666, 350.764, 351.955, 353.049, 354.24, 355.896, 357.096, 358.103, 359.392, 360.585, 361.874, 362.976, 364.175, 365.28, 366.756, 368.043, 369.149, 370.72, 372.666, 374.897, 376.661, 379.179, 380.946, 382.992, 384.951, 386.81, 389.427, 392.323, 394.941, 398.409, 401.78, 405.529, 408.717, 412.844, 416.315, 419.788, 423.07, 426.074, 429.923, 433.305, 436.97, 440.26]
rate =  [6.722994527131926e-06, 8.403743158914907e-06, 9.916416927519591e-06, 1.176524042248087e-05, 1.3277914191085553e-05, 5.378395621705541e-06, -2.353048084496174e-06, 8.907967748449803e-06, 1.9832833855039182e-05, 3.1934224003876647e-06, 2.369855570814004e-05, 5.395203108023371e-05, 0.00010286181626511846, 0.00013311529163721216, 0.0002193376964476791, 0.0002865676417189983, 0.0003727900465294652, 0.0004867448037643514, 0.000722721911666682, 0.0009207141004907172, 0.0012214000307166927, 0.001531498153280653, 0.0018321840835066282, 0.0021232897465314404, 0.0024518761040450135, 0.0027520578096814543, 0.0030708958251306857, 0.003464863304420616, 0.003811937896883802, 0.0042336377285981525, 0.004618193015550098, 0.0049461070736109575, 0.005377387172526471, 0.005761774384615239, 0.006136581329502844, 0.006511556349253627, 0.006924012063493171, 0.00737344424763194, 0.007813968464022259, 0.008245248562937773, 0.008610643315487393, 0.00902309902972694, 0.009491691748268031, 0.009913391579982382, 0.010372404031322313, 0.010803684130237828, 0.011253620538966131, 0.0116380077510549, 0.012087776084920026, 0.012575025113273911, 0.0130343737143402, 0.013409180659227804, 0.013831384715531692, 0.01420652781014565, 0.014666044486075119, 0.014929249721812334, 0.015211111267362338, 0.015324897949734047, 0.015363723243128236, 0.015243045491366217, 0.015066230735302647, 0.014776637746046439, 0.014524357376415813, 0.014244512729223946, 0.013926683162953785, 0.013655914558373545, 0.013347497184441368, 0.013001767190883608, 0.012712174201627402, 0.012422245062644839, 0.012095171378899868, 0.011795998122442499, 0.01146909251356071, 0.011132606637477754, 0.010814777071207595, 0.010487703387462625, 0.010188698205868435, 0.009871036714461452, 0.009534382763515321, 0.009263446084071902, 0.00898326528715368, 0.008684260105559487, 0.00835718642181452, 0.007992632043580791, 0.007703039054324582, 0.007347896868428838, 0.007048891686834646, 0.0067406423877656475, 0.006404324586545873, 0.006095907212613695, 0.005741101176444308, 0.005526469576165621, 0.005255532896722205, 0.004984764292141966, 0.004704583495223744, 0.004433814890643505, 0.004172290403538073, 0.003948246610921402, 0.0037240347434415524, 0.0034440220213865077, 0.003163841224468284, 0.002939797431851613, 0.0026786090944725376, 0.002408176639618656, 0.0021659807617787287, 0.001960929428701205, 0.0017657945125512003, 0.0015888116816244525, 0.0013839284234101069, 0.0012445943618352977, 0.0010397111036209523, 0.0009099573092473062, 0.0007430589701112561, 0.000622885442938773, 0.0005405287599814069, 0.0004393476923480713, 0.00034774689191589884, 0.00029329063624613025, 0.0002300944876910902, 0.0001850504243593063, 0.00015899882056667004, 0.00010454256489690145, 8.739892885271505e-05, 6.151539992325712e-05, 7.26083408930248e-05, 9.344962392713376e-05, 0.00011395475723488614]

print(np.argmax(rate))
print(tem[np.argmax(rate)])

tem =  [213.427, 218.854, 224.562, 230.176, 236.725, 242.246, 247.205, 254.316, 261.708, 268.351, 274.153, 278.645, 282.762, 286.038, 289.314, 292.123, 294.838, 297.085, 298.209, 299.614, 301.113, 302.424, 303.923, 305.515, 306.733, 308.419, 309.637, 310.855, 312.26, 314.133, 315.444, 317.036, 319.002, 321.061, 323.401, 326.488, 328.733, 330.885, 332.942, 334.813, 336.215, 337.524, 339.02, 340.89, 342.105, 343.882, 344.911, 346.874, 348.557, 350.334, 351.923, 353.232, 355.196, 356.972, 358.936, 361.742, 364.08, 366.231, 369.224, 371.468, 373.994, 377.362, 380.355, 383.442, 388.213, 393.078, 397.662, 402.902, 407.205, 411.883, 417.497, 422.831, 427.603, 432.375, 437.334]
rate =  [4.907786004806306e-05, 6.067502560736563e-05, 8.16843835046529e-05, 0.00010269374140194017, 0.00012420732388876234, 7.966748514651333e-05, 0.0001005087681806223, 0.00014084673534341385, 0.00011580358072984742, 0.00018404197518023647, 0.0002988371067310141, 0.00047850913546861485, 0.0007141500936445888, 0.0011272781073368458, 0.0016059553176686388, 0.0021217770727628357, 0.002768529146272927, 0.0033030072111799157, 0.0037151267756931027, 0.004174307301896213, 0.004773830338853202, 0.005382765568148176, 0.005898083098652839, 0.00657256752458735, 0.007106373290041624, 0.007724720711674583, 0.00831483155629359, 0.008764599890158714, 0.009364122927115703, 0.009823303453318813, 0.01034803317616146, 0.01078855739255178, 0.011257150111092875, 0.011576324276268464, 0.011754987855826994, 0.011606577751640557, 0.011373625991275435, 0.011131093963709152, 0.01074821942538899, 0.010393413389219602, 0.009944821579396725, 0.009542954581537411, 0.009150499776016088, 0.008795693739846698, 0.008449963746288938, 0.008132470329745135, 0.007814808838338152, 0.007347560718702482, 0.006880480673929991, 0.006413232554294323, 0.0060207777487729965, 0.005618910750913686, 0.0051798992082919704, 0.00471281916351948, 0.004292463930710556, 0.0038632007301531834, 0.0034991505765089893, 0.003050894916412468, 0.002668356527818662, 0.002332374876325243, 0.0020340419941837643, 0.0017358771869054631, 0.0014938493839287141, 0.0011862723843124282, 0.000926260570975601, 0.0006662487576387739, 0.0005090987605670651, 0.0003707731481713257, 0.00023227946091240807, 0.00014067866048023554, 7.748251192519546e-05, 9.832379495930443e-05, 0.00010034069331744399, 0.00013042609382635936, 0.00011378668237170786]

print(np.argmax(rate))
print(tem[np.argmax(rate)])

tem  = [213.053, 218.105, 222.784, 228.772, 233.731, 239.626, 244.679, 249.825, 256.936, 263.392, 270.035, 276.304, 282.761, 287.907, 292.96, 298.106, 302.692, 306.248, 309.618, 312.707, 315.421, 318.042, 320.102, 322.629, 324.689, 326.655, 328.715, 330.868, 334.144, 337.607, 341.349, 344.53, 347.149, 349.114, 351.359, 353.136, 354.913, 355.848, 358.28, 360.337, 363.33, 365.388, 368.288, 370.813, 373.526, 376.987, 380.541, 386.155, 392.142, 399.721, 406.083, 413.287, 418.34, 424.515, 429.568, 436.117, 441.731]
rate = [5.832197752286945e-05, 4.1682566068217946e-05, 3.4119197225194526e-05, 3.6640320172869e-05, 2.9413101056202175e-05, 5.0590533816667744e-05, 7.126374198759842e-05, 8.2860907546901e-05, 6.706187040814096e-05, 8.840737803178483e-05, 5.378395621705541e-05, 6.571727150271458e-05, 9.647497146434313e-05, 0.0001453847566492279, 0.00023177523632287315, 0.00037430272029807007, 0.0006568365653007891, 0.0009671027627279275, 0.0013148496546438264, 0.0017091532836601138, 0.001981602636872135, 0.0024693558898155566, 0.002900804063594248, 0.0033978014340124755, 0.0038384937252659733, 0.004269773824181486, 0.004672985420946223, 0.005104433594724915, 0.005480080913928411, 0.005752866416866788, 0.005791859785124155, 0.005634037488599732, 0.005382597493284998, 0.0051681339678694895, 0.0049163578228284, 0.00466441360292413, 0.004421881575357846, 0.004160189013389236, 0.0038430317465717873, 0.0035257064048911605, 0.003171236518448129, 0.002807186364803936, 0.002536921984813232, 0.002238589102671753, 0.001884119216228722, 0.0015861224838135996, 0.0012412328645717318, 0.0009067638868469185, 0.0006378441057616415, 0.0004818706327321808, 0.00027866812314961836, 0.00017866357955853093, 0.00012454347361511893, 8.975197693721122e-05, 9.176887529535077e-05, 9.445807310620355e-05, 9.681112119069973e-05]

print(np.argmax(rate))
print(tem[np.argmax(rate)])


tem = [213.614, 218.947, 224.655, 230.363, 236.164, 242.246, 246.83, 252.445, 257.029, 262.83, 269.38, 276.023, 281.544, 286.877, 294.643, 301.287, 307.275, 312.797, 316.914, 321.687, 326.554, 330.859, 334.884, 338.908, 342.932, 348.828, 352.664, 355.564, 359.119, 362.393, 365.106, 368.193, 370.999, 373.899, 376.519, 380.167, 383.254, 386.809, 389.616, 392.984, 397.101, 402.059, 405.989, 410.012, 415.345, 421.521, 426.573, 431.72, 436.211, 440.796]
rate = [4.907786004806306e-05, 4.2018715794574536e-05, 2.5547379203101317e-05, 9.244117474806399e-06, 3.9665667710078364e-05, 5.159898299573753e-05, 1.6135186865116622e-05, 3.714454476240389e-05, 3.899336825736517e-05, 1.3277914191085553e-05, 6.722994527131926e-06, 2.8236577013954092e-05, 2.353048084496174e-06, 4.53802130581405e-06, 6.403652287093159e-05, 5.731352834379967e-05, 0.00020017716204535308, 0.0004364904196740403, 0.0006907876876628054, 0.0010017261845426569, 0.0014061143053496422, 0.0018476469709190317, 0.0023453166407899724, 0.0027587808042085857, 0.003059970959024096, 0.0033337649111415436, 0.0033352775849101487, 0.0031961115981985174, 0.00294500775261014, 0.002618774443181064, 0.0023390978708523755, 0.002125138570026402, 0.0018642863823736832, 0.0016315026968717404, 0.0013987190113697971, 0.0011756836679321955, 0.0009523121747682373, 0.0007852457607690089, 0.0006741482762081539, 0.0005539747490356708, 0.0004433814890643505, 0.00032371218648140224, 0.00022236304398488846, 0.00014925047850232877, 0.00010454256489690145, 8.840737803178483e-05, 7.17679665771333e-05, 7.395293979845119e-05, 9.462614796938186e-05, 0.00010588716380232783]

print(np.argmax(rate))
print(tem[np.argmax(rate)])

tem = [213.52, 217.263, 222.69, 226.994, 230.924, 235.509, 239.532, 244.772, 249.638, 254.129, 259.088, 263.86, 268.725, 273.497, 278.363, 283.509, 288.749, 294.363, 298.854, 303.719, 309.801, 315.509, 321.591, 326.55, 331.79, 336.469, 340.305, 344.984, 349.663, 354.997, 359.021, 362.015, 365.758, 369.687, 372.868, 376.424, 379.792, 383.441, 386.902, 391.393, 396.165, 401.311, 407.018, 412.258, 416.562, 422.456, 426.76, 430.877, 434.807, 438.456, 442.293]
rate = [-7.059144253488523e-06, 3.8657218531008576e-06, 6.050695074418733e-06, 1.714363604418641e-05, 2.8236577013954092e-05, 1.1429090696124276e-05, 2.2353956802713652e-05, 3.3951122362016225e-05, 2.6555828382171105e-05, 2.8404651877132394e-05, 1.176524042248087e-05, 2.3194331118605145e-05, 1.5799037138760026e-05, 8.403743158914907e-06, 1.9832833855039182e-05, 2.184973221317876e-05, 2.403470543449664e-05, 3.5799945856977506e-05, 2.8236577013954092e-05, 3.025347537209367e-05, 4.218679065775284e-05, 6.31961485550401e-05, 0.00013126646814225085, 0.00018017625332713563, 0.0002665667330007808, 0.0003153084433224873, 0.0004665758201829556, 0.0006275915391077653, 0.0008260879525213354, 0.0010247524407980839, 0.0011200508882201789, 0.0011306396046004115, 0.0011321522783690164, 0.0010776960226992478, 0.0010602162369287048, 0.0009213863999434305, 0.0008104569902457538, 0.0007091078477492399, 0.0005795221282387719, 0.0004596847507926455, 0.00036808395036047294, 0.0002858953422662852, 0.00016673026427287179, 7.529753870387756e-05, 4.8909785184884764e-05, 4.2018715794574536e-05, 3.445534695155112e-05, 5.49604802593035e-05, 7.529753870387756e-05, 9.546652228527335e-05, 6.891069390310224e-05]


print(np.argmax(rate))
print(tem[np.argmax(rate)])

import matplotlib.pyplot as plt
plt.figure()
plt.plot(tem, rate)
plt.ylim([0, 1.1 * max(rate)])
plt.show()